<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoice Register</title>
</head>
<body>
  <h1>Invoice Register</h1>
  <form id="csvForm">
    <label for="csvFile">Selecione o arquivo CSV de origem:</label><br>
    <input type="file" id="csvFile" name="csvFile" accept=".csv"><br><br>

    <label for="outputFileName">Digite o nome do arquivo de saída:</label><br>
    <input type="text" id="outputFileName" name="outputFileName"><br><br>

    <button type="submit">Gerar arquivo de saída</button>
  </form>

  <script>
    async function processCsvFile(csvFile, outputFileName) {
      const fileReader = new FileReader();

      return new Promise((resolve, reject) => {
        fileReader.onload = function(event) {
          const csvData = event.target.result;

          fetch('/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              csvData: csvData,
              outputFileName: outputFileName
            })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Erro ao gerar o arquivo de saída.');
            }
            return response.blob();
          })
          .then(blob => resolve(blob))
          .catch(error => reject(error));
        };

        fileReader.readAsText(csvFile);
      });
    }

    document.getElementById('csvForm').addEventListener('submit', async function(event) {
      event.preventDefault();

      const csvFile = document.getElementById('csvFile').files[0];
      const outputFileName = document.getElementById('outputFileName').value.trim();

      if (!csvFile) {
        alert('Por favor, selecione um arquivo CSV de origem.');
        return;
      }

      if (!outputFileName) {
        alert('Por favor, digite o nome do arquivo de saída.');
        return;
      }

      try {
        const blob = await processCsvFile(csvFile, outputFileName);
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = outputFileName + '.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error(error);
        alert('Erro ao gerar o arquivo de saída. Por favor, tente novamente.');
      }
    });
  </script>
</body>
</html>